- name: Update and Upgrade Package
  gather_facts: true
  hosts: "{{ host_group }}"

  vars:
    ansible_python_interpreter: "/usr/bin/python3"
    playbook_file_path: "{{ (lookup('file', '/proc/self/cmdline') | regex_replace('\u0000',' ')).split() | select('match','^.*[.]ya?ml$') | list | first }}"
    playbook_file_name: "{{ playbook_file_path | basename }}"

  tasks:

  - name: Wait for updates completed file to be created
    become: yes
    become_user: root
    wait_for:
      path: /root/user_data_completed
      state: present

  - name: Update apt cache and upgrade packages (for Debian/Ubuntu)
    become: yes
    become_user: root
    apt:
      update_cache: yes
      upgrade: dist
      autoremove: yes
      autoclean: yes
    register: apt_update_upgrade_result
    when: ansible_os_family == "Debian"

  - name: Install pip
    become: true
    become_user: root
    apt:
      name: python3-pip
      state: present
    when: ansible_os_family == 'Debian'

  - name: Install Pip (for RedHat/CentOS)
    become: true
    become_user: root
    yum:
      name: python3-pip
      state: present
    when: ansible_os_family == 'RedHat'

  - name: Install Jinja2
    # become: true
    # become_user: root
    pip:
      name: Jinja2
      executable: pip3

  - name: Install kubernetes Python Library
    # become: true
    # become_user: root
    pip:
      name: kubernetes
      state: present